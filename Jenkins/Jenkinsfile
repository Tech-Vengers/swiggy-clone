pipeline {
  agent any

  environment {
    IMAGE = "dockerhub_user/swiggy:${BUILD_NUMBER}"
  }

  stages {

    stage('Checkout') {
      steps { 
        git branch: 'main',
        url: 'https://github.com/Tech-Vengers/swiggy-clone' }
    }

    stage('SonarQube') {
  environment {
    SCANNER_HOME = tool 'sonar-scanner'
  }
  steps {
    withSonarQubeEnv('sonarqube-server') {
      sh """
        ${SCANNER_HOME}/bin/sonar-scanner \
        -Dsonar.projectKey=swiggy
      """
    }
  }
}

    stage('Dependency Scan') {
      steps { sh './security/dependency-check.sh' }
    }

    stage('Build Image') {
      steps { sh 'docker build -t $IMAGE .' }
    }

    stage('Trivy Image Scan') {
      steps { sh 'trivy image $IMAGE' }
    }

    stage('Push Image') {
      steps {
        sh '''
        docker login -u $DOCKERHUB_USER -p $DOCKERHUB_PASS
        docker push $IMAGE
        '''
      }
    }

    stage('Terraform Deploy') {
      steps {
        sh '''
        cd terraform
        terraform init
        terraform apply -auto-approve -var="image=$IMAGE"
        '''
      }
    }

    stage('Switch Traffic') {
      steps {
        sh '''
        aws elbv2 modify-listener \
        --listener-arn $LISTENER_ARN \
        --default-actions Type=forward,TargetGroupArn=$GREEN_TG
        '''
      }
    }
  }
}
